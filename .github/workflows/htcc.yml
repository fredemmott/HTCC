name: Build HTCC
on:
  push:
    paths-ignore:
      - 'docs/**'
      - '.github/workflows/pages.yml'
  pull_request:
    paths-ignore:
      - 'docs/**'
      - '.github/workflows/pages.yml'
jobs:
  build:
    name: ${{matrix.preset}}
    runs-on: windows-latest
    strategy:
      matrix:
        preset:
          - Debug
          - Debug - clang-cl
          - Release
    env:
      VCPKG_DEFAULT_BINARY_CACHE: ${{github.workspace}}/.vcpkg-binary-cache
    steps:
      - name: Set up visual studio environment
        shell: pwsh
        run: |
          $VSRoot = $(
            vswhere `
              -latest `
              -products * `
              -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 `
              -property installationPath)
          cmd /c "`"${VSRoot}/VC/Auxiliary/Build/vcvarsall.bat`" x64&set" `
            | Where-Object { $_ -like '*=*' } `
            | Out-File -Encoding utf8 -Append $Env:GITHUB_ENV
      - uses: actions/checkout@v4
        with:
          path: source
          fetch-depth: 0
          submodules: true
      - name: Make build directory
        run: cmake -E make_directory build
      - name: Setup vcpkg binary cache
        uses: actions/cache@v4
        with:
          key: ${{matrix.preset}}-${{hashFiles('source/vcpkg.json', 'source/vcpkg-configuration.json')}}
          path: ${{env.VCPKG_DEFAULT_BINARY_CACHE}}
      - name: Configure
        working-directory: build
        shell: pwsh
        run: |
          cmake -E make_directory "${{env.VCPKG_DEFAULT_BINARY_CACHE}}"
          $args = @()
          if ("${{github.ref_type}}" -eq "tag") {
            $args += "-DIS_TAGGED_BUILD=ON"
          }
          if (-not "${{matrix.preset}}" -contains "clang") {
            $args += "-DSOURCELINK=https://raw.githubusercontent.com/fredemmott/HTCC/${{github.sha}}"
          }
          cmake `
            ${{github.workspace}}/source `
            --preset "${{matrix.preset}}" `
            -DVERSION_TWEAK=${{github.run_number}} `
            -DVERSION_TWEAK_LABEL=gha `
            @args
      - name: Build
        id: build
        working-directory: build
        run: |
          cmake --build . `
            --parallel
          $version="$(Get-Content version.txt)"
          Add-Content $Env:GITHUB_OUTPUT "VERSION=${version}"
      - name: Upload binaries
        uses: actions/upload-artifact@v4
        if: matrix.preset == 'Release'
        with:
          name: HTCC-v${{steps.build.outputs.VERSION}}
          path: |
            build/out/RelWithDebInfo/**/*
            !build/out/RelWithDebInfo/**/*.pdb
      - name: Upload debug symbols
        uses: actions/upload-artifact@v4
        if: matrix.preset == 'Release'
        with:
          name: HTCC-v${{steps.build.outputs.VERSION}}-DebugSymbols
          path: build/out/RelWithDebInfo/**/*.pdb
  installer-generator:
    name: Installer Generator
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    - name: Build
      working-directory: HTCC-Installer
      shell: pwsh
      run: |
        dotnet publish `
          --configuration Release `
          --output "${{runner.temp}}/installer" `
          HTCC-Installer.csproj
    - uses: actions/upload-artifact@v4
      with:
        name: htcc-installer-generator
        path: ${{runner.temp}}/installer